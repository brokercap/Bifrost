{{template "header" .}}

<link href="/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet" xmlns="http://www.w3.org/1999/html">
<div >
    <input type="hidden" value="{{.DbName}}" id="dbname" />
    <div class="row">
        <div class="col-sm-2" id="MyWebLeft_1">

            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>{{.DbName}} - Schema List</h5>
                </div>
                <div class="ibox-content">
                    <div class="list-group" id="DatabaseListContair">
                    {{range $i, $v := .DataBaseList}}
                        <a class="list-group-item" id="Schema-{{$v}}">
                            <h3 class="list-group-item-heading">{{$v}}</h3>
                        </a>
                    {{end}}
                    </div>

                </div>
            </div>

        </div>
        <div class="col-sm-3" style=" padding-left: 0px;" id="MyWebLeft_2">
            <div class="ibox float-e-margins">
                <div class="ibox-title" style="position: relative">
                    <h5>Table List</h5>
                    <div  style="margin-left: 70px; margin-top:-10px; width: 50%" ><input type="text" class="form-control" placeholder="search" id="TableSearchName"></div>
                    <div id="MyWebHideBtn" onclick="showOrHideMyWeb();" style="position: absolute;right: 20px; top: 15px; font-weight:600; color:#666; cursor:pointer">Hide</div>
                </div>
                <style type="text/css">
                    .tableDiv{display:block; width:100%; height: 25px; position: relative}
                    .tableDiv .left{ display:block; float:left; width:79%; line-height:100%;word-wrap: break-word;  }
                    .tableDiv .right{ display:block; position: absolute; right: -10px ;top: 0px; width:78px; line-height: 25px;}
                    .tableDiv .right1{ display:block; position: absolute; right: 48px ;top: 0px; width:78px; line-height: 25px;}
                    .tableDiv .right .button{ float: left;}
                    .tableDiv .right .check_input{ float: left;margin-left: 8px; margin-top: 2px}
                    .tableDiv .right1 .button{ float: left;}
                </style>
                <div class="ibox-content">
                    <div class="list-group" id="TableListContair">

                    </div>
                    <div id="bachTableDelOrAddBtnDiv">
                        <button data-toggle="button" class="btn-sm btn-danger" type="button" id="batchTableDeleteBtn">批量删除</button>
                        <button data-toggle="button" class="btn-sm btn-warning" id="batchTableChanneBindBtn" type="button">批量绑定通道</button>
                    </div>
                    <div style="line-height: 150%; padding: 10px">
                        <p>点击 ADD 按钮后再点击表名,让表名的背景变成绿色</p>
                        <p>多选框选中只能用于批量操作,要针对某一个表添加同步设置，请<strong style="color: #F00">点击</strong>表名，让表背景变成绿色</p>
                    </div>

                    <div id="batchDelOrAddTableResultDiv" style="padding-top: 20px; display:none"></div>
                </div>
            </div>
        </div>
        <div class="col-sm-7" style=" padding-left: 0px;" id="MyWebLeft_3">
            <div class="ibox float-e-margins">
                <div class="ibox-title" >
                    <h5>Table ToServer List
                        <span id="tableSelectShowDiv" style="display: none">
                        <a  href="#" id="tableFlowBtn" target="_blank"><button class="btn-sm btn-primary" type="button" style="margin-top: -8px">Flow</button></a>
                        &nbsp;
                        <button class="btn-sm btn-primary" id="historyAddBtn" type="button" style="margin-top: -8px" title="点击后可配置读取数据表的数据进行全量数据初始化">刷全量数据</button>
                        &nbsp;
                        <a href="#" id="tableHistoryListBtn">
                        <button class="btn-sm btn-primary" id="" type="button" style="margin-top: -8px">查看全量任务列表</button>
                        </a>
                        </span>
                    </h5>
                </div>
                <div class="ibox-content">

                    <!--list start--->
                    <div class="example-wrap">
                        <div class="example">
                            <table id="tableToServerListContair" schema="" table_name="" dbname="" data-toggle="table" data-query-params="queryParams" data-mobile-responsive="true" data-height="auto" data-pagination="false" data-icon-size="outline">
                                <thead>
                                <tr>
                                    <th data-field="sliceid">sliceId/ID</th>
                                    <th data-field="PluginName">PluginType</th>
                                    <th data-field="ToServerKey">ToServerKey</th>
                                    <th data-field="FieldList">FieldList</th>
                                    <th data-field="Others">Others</th>
                                    <th data-field="PluginParam">PluginParam</th>
                                    <th data-field="Error">Error</th>
                                    <th data-field="op">op</th>
                                </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    <!--list end -->

                </div>


                <div class="ibox-content" id="addToServerContair">
                    <div class="row row-lg">

                        <!-- left -->
                        <div class="col-md-7">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">ToServerKey：</label>
                                <div class="col-sm-9" style="position: relative">
                                    <select class="form-control" name="addToServerKey" id="addToServerKey">
                                    {{range $k,$v := .ToServerList}}
                                        <option value="{{$k}}" pluginName="{{$v.PluginName}}" pluginVersion="{{$v.PluginVersion}}">{{$v.PluginName}} -- {{$k}}</option>
                                    {{end}}
                                    </select>
                                    <span class="help-block m-b-none"></span>
                                    <div style="position: absolute; top: 0px; right: -30px;">
                                        <a href="#" target="_blank" id="addToServerKeyDoc"><button class="btn-sm btn-primary" type="button" style="padding: 5px">DOC</button></a>
                                    </div>
                                </div>
                            </div>

                            <div id="plugin_param_div" style="padding:10px 0px">

                            </div>

                            <div class="form-group">
                                <label class="col-sm-3 control-label">MustBeSuccess：</label>
                                <div class="col-sm-9">
                                    <select class="form-control" name="MustBeSuccess" id="MustBeSuccess">
                                        <option value="true" selected="selected">True</option>
                                        <option value="false">False</option>
                                    </select>
                                    <p class="help-block m-b-none">True: 插件返回失败，自动重试，直到成功为止</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-3 control-label">FilterQuery：</label>
                                <div class="col-sm-9">
                                    <select class="form-control" name="FilterQuery" id="FilterQuery">
                                        <option value="true" selected="selected">True</option>
                                        <option value="false">False</option>
                                    </select>
                                    <p class="help-block m-b-none">True: 将过滤sql 事件，不提供给插件层处理，False: 由插件层自行决定怎么处理</p>
                                </div>
                                
                            </div>
                            
                            <div class="form-group">
                                <label class="col-sm-3 control-label">FilterUpdate：</label>
                                <div class="col-sm-9">
                                    <select class="form-control" name="FilterUpdate" id="FilterUpdate">
                                        <option value="true" selected="selected">True</option>
                                        <option value="false">False</option>
                                    </select>
                                    <p class="help-block m-b-none">True: update事件，所选字段内容都没有变更情况下，不进行推送，False: 不管字段有没有更新，全部都会推送</p>
                                </div>
                                
                            </div>

                            <div class="form-group">
                                <label class="col-sm-3 control-label">&nbsp;</label>
                                <div class="col-sm-9" style="padding-top: 15px;">
                                    <button data-toggle="button" class="btn-sm btn-primary" id="addToServerBtn" type="button">提交</button>
                                    <button data-toggle="button" class="btn-sm btn-success" id="batchAddToServerBtn" type="button">批量提交</button>
                                    <p>&nbsp;</p>
                                    <p style="color:#F00">批量提交，将会提交到多选框选中并且已绑定Channel的表里,批量提交,字段不能选,默认全选</p>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-sm-3 control-label">&nbsp;</label>
                                <div class="col-sm-9" style="padding-top: 15px;" id="batchAddToServerResultDiv">

                                </div>
                            </div>
                        </div>

                        <!-- left end-->
                        <!-- right start-->

                        <div class="col-md-5">
                            <label class="col-sm-2 control-label">Fields：</label>
                            <div class="col-sm-10" id="TableFieldsContair">

                            </div>
                        </div>

                        <!-- right end-->

                    </div>
                </div>
            </div>


        </div>
    </div>

    <!--add table start-->
    <div class="modal inmodal fade" id="addTableDiv" tabindex="-1" role="dialog"  aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h3 class="modal-title">Add New Table</h3>
                </div>
                <div class="modal-body">
                    <table width="100%" border="0">
                        <tr>
                            <td align="right" height="50" width="20%">DB : </td>
                            <td style="text-indent:10px" >
                                <input type="text" name="dbname" id="addTableDbName" class="form-control" placeholder="Database" value="{{.DbName}}" disabled>
                            </td>
                        </tr>

                        <tr>
                            <td align="right" height="50" width="20%">Schema : </td>
                            <td style="text-indent:10px" >
                                <input type="text" name="schema" class="form-control" placeholder="Database" value="" id="addTableSchema" disabled>
                            </td>
                        </tr>

                        <tr>
                            <td align="right" height="50" width="20%">TableName : </td>
                            <td style="text-indent:10px" >
                                <input type="text" name="table_name" class="form-control" placeholder="TableName" value="" id="addTableName" disabled>
                                <input type="hidden" name="table_name_old" class="form-control"  value="" id="addTableNameOld">
                                <div id="FuzzyMatchingTableNames" style="word-wrap: break-word;word-break: normal; width: auto;"></div>
                            </td>
                        </tr>

                        <tr>
                            <td align="right" height="50" width="20%">FuzzyMatching : </td>
                            <td style="text-indent:10px" >
                                <select class="form-control" name="" id="AddTableIsFuzzyMatching" >
                                    <option value="0">No</option>
                                    <option value="1">Yes</option>
                                </select>
                                <p style="padding-top: 5px">Yes 可以修改表名 带 * 的模糊匹配规则,例如: binlog_field_test_*</p>
                                <p><a href="/docs#FuzzyMatching" target="_blank">模糊匹配文档</a></p>
                            </td>
                        </tr>

                        <tr>
                            <td align="right" height="50">ChannelKey :  </td>
                            <td style="text-indent:10px">
                                <select class="form-control" name="" id="AddTableChannel" >
                                {{range $k,$v := .ChannelList}}
                                    <option value="{{$k}}">{{$v.Name}}</option>
                                {{end}}
                                </select>
                            </td>
                        </tr>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-sm btn-white" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn-sm btn-primary" onclick="AddTable(this)">保存</button>
                </div>
            </div>
        </div>
    </div>
    <!--add table over-->

<!--显示模糊匹配表 匹配所有表 start-->
<div class="modal inmodal fade" id="showLikeTable" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title" id="showLikeTable_Title"></h3>
            </div>
            <div class="modal-body" id="showLikeTable_Body">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn-sm btn-white" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    function ShowLikeTableNames(tableName) {
        var tableNames = getTablesByLikeName(tableName);
        $("#showLikeTable_Title").text(tableName);
        var html = "";
        for (var name of tableNames.split(";")) {
            html += "<p>"+name+"</p>";
        }
        $("#showLikeTable_Body").html(html);
        $("#showLikeTable").modal('show');
    }
</script>
<!--显示模糊匹配表 匹配所有表 over-->

    <script src="/js/bootstrap.min.js?v=3.3.6"></script>
    <script src="/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="/js/md5.min.js"></script>
    <script type="text/javascript">

        var dbname = "{{.DbName}}";
        var SchemaName = "";
        var TableName = ""
        var OnFoucsInputId = "";
        var tableDataTypeMap = {};
        var TableMap = new Map();
        var DataBaseMap = new Map();

        function getDbName() {
            return dbname;
        }
        function setSchemaName(name) {
            SchemaName = name
        }

        function getSchemaName() {
            return SchemaName;
        }

        function setTableName(name) {
            TableName = name
        }

        function getTableName() {
            return TableName
        }

        function getTableFieldType(field) {
            return tableDataTypeMap[field];
        }

        function clearTableDataMap() {
            tableDataTypeMap = {};
        }
        function setTableFieldType(field,dataType) {
            tableDataTypeMap[field] = dataType;
        }

        function setPluginParamDefault(key,value) {
            if (key == undefined || key == null){
                $("#MustBeSuccess").val("true");
                $("#FilterQuery").val("true");
                $("#MustBeSuccess").val("true");
                return;
            }
            switch (key){
                case "FilterUpdate":
                    if (value != false && value != "false"){
                        $("#FilterUpdate").val("true");
                    }else{
                        $("#FilterUpdate").val("false");
                    }
                    break;
                case "FilterQuery":
                    if (value != false && value != "false"){
                        $("#FilterQuery").val("true");
                    }else{
                        $("#FilterQuery").val("false");
                    }
                    break;
                case "MustBeSuccess":
                    if (value != false && value != "false"){
                        $("#MustBeSuccess").val("true");
                    }else{
                        $("#MustBeSuccess").val("false");
                    }
                    break;
                default:
                    break;
            }
            return;
        }

        function showOrHideMyWeb(){
            var status = $("#MyWebHideBtn").attr("status");
            if (status == "hide"){
                $("#MyWebLeft_2").removeClass("col-sm-1").addClass("col-sm-3");
                $("#MyWebLeft_3").removeClass("col-sm-11").addClass("col-sm-7");
                $("#MyWebLeft_1").show();
                $("#MyWebHideBtn").attr("status","show");
            }else{
                $("#MyWebLeft_1").hide();
                $("#MyWebLeft_2").removeClass("col-sm-3").addClass("col-sm-1");
                $("#MyWebLeft_3").removeClass("col-sm-7").addClass("col-sm-11");
                $("#MyWebHideBtn").attr("status","hide");
            }
        }

        function showBatchDelOrAddBtn() {
            $("#bachTableDelOrAddBtnDiv").show();
        }
        $("#bachTableDelOrAddBtnDiv").hide();

        function showAddTable(table_names){
            if (table_names == ""){
                return false;
            }
            var addTableSchemaName = $("#DatabaseListContair a.active").find("h3").text();
            $("#addTableSchema").val(addTableSchemaName);
            var dbname = $("#dbname").val();
            var url = "/channel/list";
            $("#addTableName").val(table_names);
            $("#addTableNameOld").val(table_names);
            $.get(url,
                    {dbname:dbname},
                    function(data,status){
                        if( status != 'success' ){
                            alert("reqeust error, reqeust status : "+status);
                            return false;
                        }
                        var html = '';
                        $.each(data,function(index,v){
                            html += '<option value="'+index+'">'+v.Name+'</option>';
                        });
                        $("#AddTableChannel").html(html);
                    },
                    'json');
            if ( table_names.charAt(table_names.length - 1 ) == ";" || table_names == "AllTables"){
                $("#AddTableIsFuzzyMatching").val("0");
                $("#AddTableIsFuzzyMatching").attr("disabled","disabled");
                $("#addTableName").attr("disabled","disabled");
            }else{
                $('#AddTableIsFuzzyMatching').removeAttr("disabled");
            }
            $("#addTableDiv").modal('show');
        }

        function batchDelOrAddTableResultFun(content,type) {
            if(type == -1){
                $("#batchDelOrAddTableResultDiv").show();
            }
            if (type == 0 || type == -1 ){
                $("#batchDelOrAddTableResultDiv").html("<p>"+content+"</p>");
            }else{
                $("#batchDelOrAddTableResultDiv").append("<p>"+content+"</p>");
            }
            if(type == -2){
               // $("#batchDelOrAddTableResultDiv").hide();
            }
        }

        $("#batchTableChanneBindBtn").click(
            function () {
                var table_names = "";
                $("#TableListContair .check_input input[type='checkbox']:checked").each(function (index, item) {
                    if($(this).parent().parent().find(".button button").text()=="ADD"){
                        table_names += $(this).val()+";"
                    }
                });
                showAddTable(table_names);
            }
        );

        $("#batchTableDeleteBtn").click(
                function () {
                    var table_names = "";
                    $("#TableListContair .check_input input[type='checkbox']:checked").each(function (index, item) {
                        if($(this).parent().parent().find(".button button").text()=="DEL"){
                            table_names += $(this).val()+";"
                        }
                    });
                    DelTable(table_names);
                }
        );

        $("#AddTableIsFuzzyMatching").change(
            function () {
                if( $(this).val() == 1 ){
                    $('#addTableName').removeAttr("disabled");
                }else{
                    $("#addTableName").val($("#addTableNameOld").val());
                    $("#addTableName").attr("disable","disable");
                }
            }
        );

        $("#addTableName").change(
            function () {
                var tableNames = getTablesByLikeName($(this).val());
                $("#FuzzyMatchingTableNames").width($("#AddTableIsFuzzyMatching").width());
                $("#FuzzyMatchingTableNames").text(tableNames);
            }
        );

        function TransferLikeTableReq(table_name) {
            if (table_name == "AllTables") {
                return ".*";
            }else{
                var reqTableName = table_name;
                // 第一个字符如果是 * 的情况下,则自动替换成 (.*), 因为第一个字符是 * 的情况下,正则是错误的
                if (reqTableName.charAt(0) == "*"){
                    reqTableName = "(.*)"+reqTableName.substr(1,reqTableName.length-1);
                }
                // 只要前面不是 （.*）,则自动替换面 ^ 开头，代表前面没数据了
                if ((reqTableName.indexOf("(.*)") != 0) && reqTableName.charAt(0) != "^") {
                    reqTableName = "^"+reqTableName
                }
                // 假如末尾是 *，则替换面 (.*)
                // binlog_field_test_*  会匹配 出 binlog_field_test ，但是  binlog_field_test_（.*） 不会匹配 binlog_field_test 出来
                if (reqTableName.charAt(reqTableName.length-1) == "*"){
                    reqTableName = reqTableName.substr(0,reqTableName.length-1)+"(.*)";

                }
                // 字符串如果不是 (.*) 结尾,则自动替换面 $,代表后面没有数据了
                if (reqTableName.length >= 4 && reqTableName.substr(reqTableName.length-4,reqTableName.length) != "(.*)" && reqTableName.charAt(reqTableName.length-1) != "$"){
                    reqTableName = reqTableName + "$";
                }
                return reqTableName;
            }
        }

        function getTablesByLikeName(table_name) {
            var table_names = "";
            var reg;
            if ( table_name != "AllTables" && table_name.indexOf("*") == -1 ){
                return "";
            }
            reg = new RegExp(TransferLikeTableReq(table_name));
            $('#TableListContair').find(":input[name=table_check_name]").each(function(){
                if( $(this).val() != "AllTables" && $(this).val().indexOf("*") == -1 ){
                    var regResult = $(this).val().match(reg);
                    if ( regResult != null && regResult != undefined){
                        table_names += $(this).val()+";";
                    }
                }
            });
            return table_names;
        }

        function AddTable(obj){
            if($(obj).text()=="正在执行"){
                return false;
            }
            var dbname = $("#dbname").val();
            var table_names = $("#addTableName").val();
            //var table_names_old = $("#addTableNameOld").val();
            var schema_name = $("#addTableSchema").val();
            var channelid = $("#AddTableChannel").val();
            if ( table_names == "" ){
                return false;
            }
            if ( table_names == "*" ){
                return false;
            }
            if ( $("#AddTableIsFuzzyMatching").val() == 1 ){
                if (table_names.indexOf("*") == -1){
                    alert("选择了模糊匹配,但 TableName 匹配规则有问题，没有 *，请参考文档后再进行设置 ！");
                    return false;
                }
                var tableNames = getTablesByLikeName(table_names)
                if (tableNames == ""){
                    alert("匹配规则 设置有问题，请参考文档后再进行设置 ！");
                    return false;
                }
                if( !confirm("请确认是否匹配正确："+tableNames ) ) {
                    return false;
                }
            }
            $(obj).text("正在执行");
            var url = "/table/add";
            var arr = table_names.split(";");
            $("#addTableDiv").modal('hide');
            batchDelOrAddTableResultFun("开始添加",-1);
            for( var i in arr) {
                var table_name = arr[i];
                if ( table_name == "" ){
                    continue;
                }
                if ( table_name == "*" ){
                    continue;
                }
                $.ajax({
                    type : "post",
                    url : url,
                    data:{dbname: dbname, schema_name: schema_name, table_name: table_name, channelid: channelid},
                    async : false,  //同步
                    dataType:"json",
                    success : function(data,status){
                        if( status != 'success' ){
                            alert("reqeust error, reqeust status : "+status);
                            return false;
                        }
                        if(data.status){
                            var tableDivId = md5(schema_name + "_-" + table_name);
                            if (table_name.indexOf("*") != -1){

                                // 往表列表末尾新增一条记录
                                var html = "";
                                var title = "";
                                title = " title='Bind Channel : " + channelid + "' ";
                                html += '<a class="list-group-item"><div class="tableDiv" title="' + table_name + '" id="' + tableDivId + '">';
                                html += '<h5 class="left" ' + title + ' onClick="GetTableToServerList(\'' + schema_name + '\',\'' + table_name + '\')">' + table_name + '</h5>';
                                html += '<div class="right1">';
                                html += '<div class="button"><button data-toggle="button" class="btn-sm btn-success" type="button" onclick="ShowLikeTableNames(\''+table_name+'\')">多表</button></div>';
                                html += '</div>';
                                html += '<div class="right">';
                                html += '<div class="button"><button data-toggle="button" class="btn-sm btn-danger" type="button" onClick="DelTable(\''+table_name+'\')">DEL</button></div>';

                                html += "<div class='check_input'> <input type='checkbox' name='table_check_name' value='"+table_name+"' style='width: 20px; height: 20px;' /></div>";
                                html += '</div>';
                                html +=	'</div></a>';
                                $("#TableListContair").append(html);

                                DataBaseMap.delete(schema_name);
                                showSchemaTableList("Schema-"+schema_name);
                            }else{
                                var html = '<button data-toggle="button" class="btn-danger btn-sm" type="button" onClick="DelTable(\''+table_name+'\')">DEL</button>';
                                $("#" + tableDivId + " .right .button").html(html);
                                $("#" + tableDivId + " .right .input input").prop("checked",false);
                            }

                        }
                        batchDelOrAddTableResultFun(table_name +" ADD Result:"+data.msg,1);
                    }
                });
            }
            batchDelOrAddTableResultFun("添加完成",-2);
            $(obj).text("提交");
        }

        function DelTable(table_names){
            if(table_names == ""){
                return false;
            }
            if (!confirm("确定删除 [ "+table_names+" ] ?删除后不能恢复!!!")){
                return false;
            }
            var dbname = $("#dbname").val();
            var schema_name = $("#DatabaseListContair a.active").find("h3").text();
            var url = "/table/del";
            var arr = table_names.split(";");
            batchDelOrAddTableResultFun("开始删除",-1);
            for( var i in arr) {
                var table_name = arr[i];
                if ( table_name == "" ){
                    continue;
                }
                $.ajax({
                    type: "post",
                    url: url,
                    data: {dbname: dbname, schema_name: schema_name, table_name: table_name},
                    async: false,  //同步
                    dataType: "json",
                    success: function (data, status) {
                        if (status != 'success') {
                            alert("reqeust error, reqeust status : " + status);
                            return false;
                        }
                        if (data.status) {
                            var tableDivId = md5(schema_name + "_-" + table_name);
                            var html = '<button data-toggle="button" class="btn-warning btn-sm" type="button" onClick="showAddTable(\'' + table_name + '\')">ADD</button>';
                            $("#" + tableDivId + " .right .button").html(html);
                            DataBaseMap.delete(schema_name);
                        }
                        batchDelOrAddTableResultFun(table_name +" DEL Result:"+data.msg,1);
                    }
                });
            }
            batchDelOrAddTableResultFun("删除完成",-2);
        }
        function ChangeTableFlowBtnHref(schema_name,table_name){
            $("#tableFlowBtn").attr("href","/flow/index?dbname="+dbname+"&schema="+schema_name+"&table_name="+table_name);
            $("#tableHistoryListBtn").attr("href","/history/list?dbname="+dbname+"&schema="+schema_name+"&table_name="+table_name);
            $("#tableSelectShowDiv").show();
        }

        //将表设置为 选中 或 非选中 状态
        function table_check_input(id) {
            var idNew = "#"+id+" .check_input input[name=table_check_name]";
            if($(idNew).is(':checked')){
                $(idNew).prop("checked", false);
            }else{
                $(idNew).prop("checked", true);
            }
        }

        function GetTableToServerList(schema_name,table_name){
            var key = md5(schema_name+"_-"+table_name);
            if ($("#"+key+" .right button").text() == "ADD"){
                table_check_input(key);
                return  false;
            }
            setTableName(table_name);
            $("#TableListContair a").removeClass("active");
            $("#"+key).parent("a").addClass("active");
            ChangeTableFlowBtnHref(schema_name,table_name);
            var url = "/table/toserver/list";
            $.post(url,
                    {dbname:dbname,schema_name:schema_name,table_name:table_name},
                    function(data,status){
                        if( status != 'success' ){
                            alert("reqeust error, reqeust status : "+status);
                            return false;
                        }
                        var e = [];
                        $.each(data,function(index,v){
                            var fields = '';
                            if (v.FieldList != null) {
                                fields = v.FieldList.toString();
                            }
                            var PluginHtml = "";
                            for(var key in v.PluginParam){
								if (typeof v.PluginParam[key] == "object"){
									PluginHtml += "<p>"+key+":"+ JSON.stringify(v.PluginParam[key]) +"</p>";
								}else{
                                	PluginHtml += "<p>"+key+":"+v.PluginParam[key]+"</p>";
								}
                            }
                            var ErrorHtml = "";
                            if (v.Error != "" && v.Error != null){
                                ErrorHtml = "<p>Err:"+v.Error+"</p><p>Data:"+v.ErrorWaitData+"</p><p><button data-toggle='button' class='btn-sm btn-primary' onClick='DealWaitErr(this,"+v.ToServerID+")' type='button'>Miss</button></p>";
                            }
                            var op = "<p>"+v.Status+"</p>";
                            if (v.Status == "stopped"){
                                op += '<p><button data-toggle="button" class="btn-sm btn-primary btn-sm" type="button" onClick="UpdateTableToServerStatus(this,'+v.ToServerID+','+index+',\'start\')">START</button></p>';
                                op += '<p><button data-toggle="button" class="btn-sm btn-danger btn-sm" type="button" onClick="UpdateTableToServerStatus(this,'+v.ToServerID+','+index+',\'del\')">DEL</button></p>';
                            }else if (v.Status == "running" || v.Status == ""){
                                op += '<p><button data-toggle="button" class="btn-sm btn-warning btn-sm" type="button" onClick="UpdateTableToServerStatus(this,'+v.ToServerID+','+index+',\'stop\')">STOP</button></p>';
                                op += '<p><button data-toggle="button" class="btn-sm btn-danger btn-sm" type="button" onClick="UpdateTableToServerStatus(this,'+v.ToServerID+','+index+',\'del\')">DEL</button></p>';
                            }else{
                                op = v.Status;
                            }
                            var others = "";

                            others += "<p>MustBeSuccess: "+v.MustBeSuccess+"</p><p>FilterQuery: "+v.FilterQuery+"</p><p>FilterUpdate: "+v.FilterUpdate+"</p>";
                            others += "<p title=\"最后一个成功处理的位点\">BinlogFileNum: "+v.BinlogFileNum+"</p><p>BinlogPos: "+v.BinlogPosition+"</p>";
                            others += "<p>LastBinlogFileNum: "+v.LastBinlogFileNum+"</p>";
                            others += "<p title=\"队列最后一个位点\">LastBinlogPosition: "+v.LastBinlogPosition+"</p>";
                            others += "<p title=\"文件队列是否启用\">FileQueueStatus: "+v.FileQueueStatus+"</p>";
                            if ("QueueMsgCount" in v) {
                                others += "<p title=\"内存队列堆积多少条数据待同步\">QueueMsgCount: " + v.QueueMsgCount + "</p>";
                            }
                            e.push({
                                sliceid:index+"/"+v.ToServerID,
                                PluginName:v.PluginName,
                                ToServerKey:v.ToServerKey,
                                FieldList:"<p style='max-width: 200px;word-wrap:break-word'>"+fields+"</p>",
                                Others:others,
                                PluginParam:PluginHtml,
                                Error:ErrorHtml,
                                op:op,
                            }
                            );
                        });
                        $("#tableToServerListContair").attr("dbname",dbname);
                        $("#tableToServerListContair").attr("schema",schema_name);
                        $("#tableToServerListContair").attr("table_name",table_name);
                        $("#tableToServerListContair").bootstrapTable("load",e);

                        var table_name_alias = "";
                        if ( table_name.indexOf("*") != -1 ){
                            var tableNames = getTablesByLikeName(table_name);
                            if ( tableNames != "" ) {
                                table_name_alias = tableNames.split(";")[0];
                            }
                            if( table_name_alias == "" ){
                                alert("没有匹配到表名！请检查配置是否正确，或者创建一个符合当前规则表，再进行选择配置！")
                                return false;
                            }
                        }else{
                            table_name_alias = table_name
                        }
                        GetTableFields(schema_name,table_name_alias);
                    },
                    'json');
        }

        function UpdateTableToServerStatus(obj,ToServerID,index,status){
            var url = "";
            var opName = "";
            switch (status){
                case "stop":
                    if (!confirm("确定暂停第 [ "+ index +" ] 条记录？")){
                        return false;
                    }
                    url = "/table/toserver/stop";
                    opName = "暂停";
                    break;
                case "del":
                    if (!confirm("确定删除第 [ "+ index +" ] 条记录？删除将不能恢复？！！！")){
                        return false;
                    }
                    url = "/table/toserver/del";
                    opName = "删除";
                    break;
                case "start":
                    url = "/table/toserver/start";
                    opName = "启动";
                    break;
                default:
                    return;
            }
            var dbname = $("#tableToServerListContair").attr("dbname");
            var schema_name = $("#tableToServerListContair").attr("schema");
            var table_name = $("#tableToServerListContair").attr("table_name");
            $.post(url,
                    {dbname:dbname,schema_name:schema_name,table_name:table_name,index:index,to_server_id:ToServerID},
                    function(data,status){
                        if( status != 'success' ){
                            alert("reqeust error, reqeust status : "+status);
                            return false;
                        }
                        if (!data.status){
                            alert(data.msg);
                            return;
                        }
                        alert(opName+"成功!");
                        GetTableToServerList(schema_name,table_name);
                    },
                    'json');
        }

        function GetTableFields(schema_name,table_name){
            var key = schema_name+"_-"+table_name;
            if (!TableMap.has(key) || TableMap.get(key) == undefined){
                var url = '/db/tablefields';
                $.post(url,
                        {dbname:dbname,schema_name:schema_name,table_name:table_name},
                        function(data,status){
                            if( status != 'success' ){
                                alert("reqeust error, reqeust status : "+status);
                                return false;
                            }
                            TableMap.set(key,data);
                            showFieldsList(key);
                        },
                        'json');
            }else{
                showFieldsList(key);
            }
        }
        function showFieldsList(key) {
            var html = "";
            clearTableDataMap();
            TableMap.get(key).forEach(function (value, k, map) {
                var phtml = "";
                setTableFieldType(value.COLUMN_NAME,value)
                phtml +='<input type="checkbox" style="width: 20px; height: 20px;" title="'+value.COLUMN_COMMENT+'" value="'+value.COLUMN_NAME+'">';
                phtml += "&nbsp;&nbsp;"+value.COLUMN_NAME;
                if (value.COLUMN_KEY == "PRI"){
                    phtml += " (PRI)";
                }
                html += '<p class="fieldsname" style="font-size: 16px; cursor: pointer">&nbsp;'+phtml+' </p>'
            });
            $("#TableFieldsContair").html(html);
        }

        function showSchemaTableList(id){
            $("#DatabaseListContair a").removeClass("active");
            $("#"+id).addClass("active");
            var schema_name = $("#"+id).find("h3").text();
            var dbname = $("#dbname").val();
            var url = "/db/tablelist";
            setSchemaName(schema_name);
            var showTableList = function(data){
                $("#TableListContair").html("");
                $.each(data,function(index,v) {
                    var html = "";
                    var title = "";
                    if (v.ChannelName != "") {
                        title = " title='Bind Channel : " + v.ChannelName + "' ";
                    }
                    var tableDivId =  md5(schema_name + '_-' + v.TableName);
                    html += '<a class="list-group-item"><div class="tableDiv" title="' + v.TableName + '" id="' + tableDivId + '">';
                    html += '<h5 class="left" ' + title + ' onClick="GetTableToServerList(\'' + schema_name + '\',\'' + v.TableName + '\')">' + v.TableName + '</h5>';
                    if (v.TableType.toUpperCase().indexOf("VIEW") != -1) {
                        html += '<div class="right1">';
                        html += '<div class="button"><button data-toggle="button" class="btn-sm btn-success" type="button">视图</button></div>';
                        html += '</div>';
                    }
                    if (v.TableType.toUpperCase().indexOf("LIKE") != -1) {
                        html += '<div class="right1">';
                        html += '<div class="button"><button data-toggle="button" class="btn-sm btn-success" type="button" onclick="ShowLikeTableNames(\''+v.TableName+'\')">多表</button></div>';
                        html += '</div>';
                    }
                    html += '<div class="right">';
                    if (v.AddStatus == false){
                        html+= '<div class="button"><button data-toggle="button" class="btn-sm btn-warning" type="button" onClick="showAddTable(\''+v.TableName+'\')">ADD</button></div>';
                    }else{
                        html+= '<div class="button"><button data-toggle="button" class="btn-sm btn-danger" type="button" onClick="DelTable(\''+v.TableName+'\')">DEL</button></div>';
                    }
                    html += "<div class='check_input'> <input type='checkbox' name='table_check_name' value='"+v.TableName+"' style='width: 20px; height: 20px;' /></div>";
                    html += '</div>';
                    html +=	'</div></a>';
                    $("#TableListContair").append(html);
                });
            }
            if (!DataBaseMap.has(schema_name) || DataBaseMap.get(schema_name) == undefined){
                $.ajax({
                    type : "get",
                    url : url,
                    data:{dbname:dbname,schema_name:schema_name},
                    async : false,  //这里用同步 ,是为了当前界第一次请求进来执行init的时候,确保执行完了这个方法,再自动执行查询toserverList
                    dataType:"json",
                    success : function(data,status){
                        if( status != 'success' ){
                            alert("reqeust error, reqeust status : "+status);
                            return false;
                        }
                        DataBaseMap.set(schema_name,data);
                        showTableList(data);
                    }
                });
            }else{
                showTableList(DataBaseMap.get(schema_name));
            }
            showBatchDelOrAddBtn();
        }

        function getPluginFunctionParam() {
            var param = {
                DbName : getDbName(),
                SchemaName: getSchemaName(),
                TableName: getTableName(),
            }
            return param;
        }

        $(function(){
            $("#plugin_param_div").on("click",":text,textarea",function(){
                OnFoucsInputId = $(this).attr("id");
            });

            $("#DatabaseListContair a").click(
                    function(){
                        $("#TableSearchName").val("");
                        showSchemaTableList($(this).attr("id"));
                    }
            );
            var doChangeToServer = function(){
                if($("#addToServerKey").val()==null){
                    if(confirm("目标库地址为空，是否跳转到 添加 目标库 ？")){
                        window.location.href = "/toserver/list";
                        return;
                    }else{
                        return;
                    }
                }
                //初始化默认参数
                setPluginParamDefault();
                var pluginName = $("#addToServerKey").find("option:selected").attr("pluginName");
                var pluginVersion = $("#addToServerKey").find("option:selected").attr("pluginversion");
                $("#plugin_param_div").load("/plugin/"+pluginName+"/www/"+pluginName+".html?v="+pluginVersion);
                $.getScript("/plugin/"+pluginName+"/www/"+pluginName+".js?v="+pluginVersion,function(){});
                $("#addToServerKeyDoc").attr("href","/docs?plugin="+pluginName+"#pluginDocName");
            }
            //type change, rule change
            $("#addToServerKey").change(function(){
                doChangeToServer();
            });
            doChangeToServer();

            $("#TableFieldsContair").on("dblclick","p.fieldsname",function(){
                if (OnFoucsInputId == ""){
                    return false;
                }
                var fieldName = $(this).find("input").val();
                $("#"+OnFoucsInputId).val($("#"+OnFoucsInputId).val()+"{$"+($.trim(fieldName))+"}");
            });

            $("#addToServerBtn").click(
                    function(){
                        if($("#addToServerKey").val()==null){
                            if(confirm("目标库地址为空，是否跳转到 添加 目标库 ？")){
                                window.location.href = "/toserver/list";
                                return false;
                            }else{
                                return false;
                            }
                        }
                        var p = doGetPluginParam(getPluginFunctionParam());;
                        if (getTableName() == "AllTables"){
                            if(  p.batchSupport != true){
                                alert("当前插件配置不支持 批量 设置!")
                                return false;
                            }
                        }
                        if (p.status == false){
                            alert(p.msg);
                            return false;
                        }
                        var dbname = $("#tableToServerListContair").attr("dbname");
                        var schema_name = $("#tableToServerListContair").attr("schema");
                        var table_name = $("#tableToServerListContair").attr("table_name");
                        if (table_name == ""){
                            alert("selected table please!");
                            return false;
                        }
                        var MustBeSuccess = $("#MustBeSuccess").val();
                        var addToServerKey = $("#addToServerKey").val();
                        var fieldlist = [];
                        $.each($("#TableFieldsContair input:checkbox:checked"),function(){
                            fieldlist.push($(this).val());
                        });
						var FilterQuery = $("#FilterQuery").val();
						var FilterUpdate = $("#FilterUpdate").val();
                        var pluginName = $("#addToServerKey").find("option:selected").attr("pluginName");
                        var url = '/table/toserver/add';
                        var data = {
                            dbname:dbname,
                            schema_name:schema_name,
                            table_name:table_name,
                            toserver_key:addToServerKey,
                            plugin_name:pluginName,
                            mustbe:MustBeSuccess,
							FilterQuery:FilterQuery,
							FilterUpdate:FilterUpdate,
                            fieldlist:fieldlist.toString(),
                            param:JSON.stringify(p.data),
                        }
                        $.post(url,
                                data,
                                function(data,status){
                                    if( status != 'success' ){
                                        alert("reqeust error, reqeust status : "+status);
                                        return false;
                                    }
                                    if(!data.status){
                                        alert(data.msg);
                                        return false;
                                    }
                                    GetTableToServerList(schema_name,table_name);
									doChangeToServer();
                                },
                                'json');
                    }
            );


            $("#batchAddToServerBtn").click(
                    function(){
                        if($("#addToServerKey").val()==null){
                            if(confirm("目标库地址为空，是否跳转到 添加 目标库 ？")){
                                window.location.href = "/toserver/list";
                                return;
                            }else{
                                return;
                            }
                        }
                        var obj = $(this);
                        if ($(obj).text() == "正在提交"){
                            return false;
                        }
                        var p = doGetPluginParam(getPluginFunctionParam());
                        if(  p.batchSupport != true){
                            alert("当前插件配置不支持 批量 设置!")
                            return false;
                        }
                        if (p.status == false){
                            alert(p.msg);
                            return false;
                        }
                        var dbname = $("#tableToServerListContair").attr("dbname");
                        var schema_name = $("#tableToServerListContair").attr("schema");
                        var tableArr = [];

                        $("#TableListContair .check_input input[type='checkbox']:checked").each(function (index, item) {
                            if($(this).parent().parent().find(".button button").text()=="DEL"){
                                tableArr.push($(this).val());
                            }
                        });

                        if (tableArr.length == 0){
                            alert("请先选择 需要同步的 表");
                            return false;
                        }
                        var fieldlist = [];
                        $.each($("#TableFieldsContair input:checkbox:checked"),function(){
                            fieldlist.push($(this).val());
                        });
                        if (fieldlist.length > 0){
                            alert("批量提交不能选择字段");
                            return false;
                        }
                        var MustBeSuccess = $("#MustBeSuccess").val();
                        var addToServerKey = $("#addToServerKey").val();

                        var FilterQuery = $("#FilterQuery").val();
                        var FilterUpdate = $("#FilterUpdate").val();
                        var pluginName = $("#addToServerKey").find("option:selected").attr("pluginName");
                        var url = '/table/toserver/add';
                        var data = {
                            dbname: dbname,
                            schema_name: schema_name,
                            table_name: "",
                            toserver_key: addToServerKey,
                            plugin_name: pluginName,
                            mustbe: MustBeSuccess,
                            FilterQuery: FilterQuery,
                            FilterUpdate: FilterUpdate,
                            fieldlist: fieldlist.toString(),
                            param: JSON.stringify(p.data),
                        }
                        $(obj).text("正在提交");
                        $("#batchAddToServerResultDiv").html("");
                        var resultFun = function (content) {
                            $("#batchAddToServerResultDiv").append("<p>"+content+"</p>");
                        }
                        resultFun("开始提交");
                        for(var i in tableArr) {
                            data.table_name = tableArr[i];
                            $.ajax({
                                type : "post",
                                url : url,
                                data:data,
                                async : false,  //同步
                                dataType:"json",
                                success : function(r,status){
                                    if( status != 'success' ){
                                        resultFun(tableArr[i]+ " reqeust error, reqeust status : "+status);
                                        return false;
                                    }
                                    if(r.status){
                                        resultFun(tableArr[i]+" success");
                                    }else{
                                        resultFun(tableArr[i]+ " "+ r.msg);
                                    }
                                }
                            });
                        }
                        resultFun("执行完成");
                        $(obj).text("批量提交");
                    }
            );

        });

        function DealWaitErr(obj,ToServerID){
            var thisButton = $(obj);
            var index0 = $(obj).parent().parent().parent("tr").children().eq(0).html();
            var dbname = $("#tableToServerListContair").attr("dbname");
            var schema_name = $("#tableToServerListContair").attr("schema");
            var table_name = $("#tableToServerListContair").attr("table_name");
            var index = index0.split("/")[0];
            var url = "/table/toserver/deal";
            $.post(
                    url,
                    {dbname: dbname,schema_name:schema_name,table_name:table_name,to_server_id:ToServerID,index:index},
                    function(data,status){
                        if( status != 'success' ){
                            alert("reqeust error, reqeust status : "+status);
                            return false;
                        }
                        if(!data.status){
                            alert(data.msg);
                            return false;
                        }
                        $(thisButton).parent().parent().html("");
                    },
                    'json'
            );
        }


        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }

        function init(){
            var querySchemaName = getQueryString("schema");
            var queryTableName = getQueryString("table_name");
            if(querySchemaName == null) {
                //默认选择第一个非 mysql 自带的库作为选中
                $.each($("#DatabaseListContair a"),function(){
                    var id = $(this).attr("id");
                    if(querySchemaName != null){
                        return;
                    }
                    // 过滤系统级别的库
                    if(id == "Schema-information_schema" || id == "Schema-mysql" || id == "Schema-performance_schema"){
                        return
                    }
                    querySchemaName = id;
                });
                if(querySchemaName != null){
                    showSchemaTableList(querySchemaName);
                }
            }else{
                if( $("#Schema-"+querySchemaName).length <= 0){
                    return false;
                }
                showSchemaTableList("Schema-"+querySchemaName);
                if(queryTableName!=null){
                    GetTableToServerList(querySchemaName,queryTableName);
                }
            }
        }

        init();

        $("#TableSearchName").keyup(function(event){
            if(event.keyCode ==13){
                var TableSearchName = $("#TableSearchName").val();
                $('#TableListContair a').each(function(){
                    var tmpName = $(this).find(":input[name=table_check_name]").val();
                    if( TableSearchName == "" || tmpName.indexOf(TableSearchName) > -1 ){
                        $(this).show();
                    }else{
                        $(this).hide();
                    }
                });
            }
        });

    </script>

{{template "db.detail.history.add" .}}

{{template "footer" .}}